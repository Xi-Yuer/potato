name: Build and Push Docker Image

# è§¦å‘æ¡ä»¶ï¼šåœ¨ build å·¥ä½œæµå®Œæˆåè§¦å‘
on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  # è‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½®SSHå¯†é’¥
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # æ·»åŠ æœåŠ¡å™¨åˆ°known_hosts
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      # æµ‹è¯•SSHè¿æ¥
      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful'"

      # éƒ¨ç½²åˆ°æœåŠ¡å™¨
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
            
            echo "å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.PROJECT_PATH }}
            echo "å½“å‰ç›®å½•: $(pwd)"
            
            # æ£€æŸ¥ docker-compose æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "é”™è¯¯: docker-compose.prod.yml æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            
            # æ‹‰å–æœ€æ–°çš„é•œåƒï¼ˆåŒ…æ‹¬nginxï¼‰
            echo "æ‹‰å–æœ€æ–°é•œåƒ..."
            docker-compose -f docker-compose.prod.yml pull
            
            # é‡å¯æœåŠ¡
            echo "é‡å¯æœåŠ¡..."
            if [ -f "deploy.sh" ]; then
              ./deploy.sh restart
            else
              echo "deploy.sh ä¸å­˜åœ¨ï¼Œä½¿ç”¨ docker-compose é‡å¯"
              docker-compose -f docker-compose.prod.yml up -d
            fi
            
            # æ¸…ç†æ—§é•œåƒ
            echo "æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
            echo "æœåŠ¡çŠ¶æ€:"
            if [ -f "deploy.sh" ]; then
              ./deploy.sh status
            else
              docker-compose -f docker-compose.prod.yml ps
            fi
            
            echo "éƒ¨ç½²å®Œæˆï¼"
          EOF

      # å¥åº·æ£€æŸ¥
      - name: Health check
        run: |
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            echo "å¼€å§‹å¥åº·æ£€æŸ¥..."
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd ${{ secrets.PROJECT_PATH }}
            
            # ä½¿ç”¨éƒ¨ç½²è„šæœ¬æ£€æŸ¥çŠ¶æ€
            if [ -f "deploy.sh" ]; then
              ./deploy.sh status
            else
              docker-compose -f docker-compose.prod.yml ps
            fi
            
            # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
            echo "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
            if curl -f --connect-timeout 10 http://localhost/health; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼æœåŠ¡è¿è¡Œæ­£å¸¸"
              echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              echo "å®¹å™¨æ—¥å¿—:"
              docker-compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi
          EOF